---
title: "BC Fed-Prov Hydrometric Network Diagnostic"
author: "Sam Albers"
date: "Generated on: `r Sys.Date()` "
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, messages = FALSE, fig.width = 8, fig.height = 12)

library(tidyverse)
library(HYDAT)
library(HYDATaddons)
library(sf)
library(ggplot2)

#station_number <- "10BE001"
station_number <- "ALL"

```

# TODO
- Split up section into Criteria and output figures accordingly
- Add in watershed/hydrozone information so that the table is more informative
- Set axes and labels on figures
- Better layer for map boundaries
- Small points on the graphs

# Introduction

This document is autogenerated to output an evaluation of the shared federal-provincial network realtime data. 

# Criteria
- Criteria 1: Does this station have any data gaps larger than `gap_threshold`?

```{r}
gap_threshold <- 3600
number_gaps <- 5
cat(paste0("gap_threshold = ", gap_threshold, " minutes"))
#cat(paste0("Analysis being conducted on any stations that have more than ", number_gaps, " instances of gaps that are 20 minutes or longer"))
```
- Criteria 2: Does this station has more than `number_gaps` gaps that are longer than 20 minutes?

```{r}
gap_threshold <- 3600
number_gaps <- 5
#cat(paste0("Analysis being conducted on all stations that have gaps of data greater than ", gap_threshold, " minutes"))
cat(paste0("number_gaps = ", number_gaps, " (number of gaps that are 20 minutes or longer)"))
```

```{r run_analysis}
gaps <- check_stn_gap(stations = station_number, gap_thres = gap_threshold, num_gaps = number_gaps) %>%
  do(st_as_sf(., coords = c("longitude", "latitude"), 
              crs = 4326, 
              agr = "constant"))

polit_bd <- st_read("H:/shape_files/political_boundaries/can_political_boundaries/prov_ab_p_geo83_e.shp", quiet = TRUE) %>%
  filter(NAME %in% c("BRITISH COLUMBIA")) %>%
  st_transform(crs = 4326, proj4string = "+proj=longlat +datum=WGS84 +no_defs")
```

## Table
To save this space, station names and numbers can be referenced here if any stations meet the criteria
```{r table}
if (is.null(gaps) == FALSE){
  knitr::kable(st_set_geometry(gaps, NULL)) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}
```

## Map 
A map is only printed is any stations meet the criteria.
```{r map}
if (is.null(gaps) == FALSE){
  ggplot(polit_bd) +
    geom_sf() +
    geom_sf(data = gaps, aes(colour = station_number, fill = station_number)) +
    coord_sf(crs = st_crs(3005)) +
    theme_minimal() +
    theme(legend.position = "bottom")
}
```

## Figure
```{r realdata}
if (is.null(gaps) == FALSE){
  all_real <- bind_realtime(stations = gaps$station_number) 
} else {
  all_real <- bind_realtime(stations = station_number)
}
```

### Stage Height
```{r hplot}
# generate the groups automatically and plot
all_real %>%
  ggplot(aes(x = date_time, y = hg)) +
  geom_line() +
  geom_point() +
  facet_wrap(~station_number, scales = "free_y") +
  theme_minimal()
```

### Discharge
```{r qplot}
# generate the groups automatically and plot
all_real %>%
  ggplot(aes(x = date_time, y = qr)) +
  geom_line() +
  geom_point() +
  facet_wrap(~station_number, scales = "free_y") +
  theme_minimal()
```
