---
output:
  html_document:
    toc: true
    fig_caption: yes
    toc_float: true
  pdf_document:
    fig_caption: yes
params:
  region:
    value: "West Coast Natural Resource Region"
  date:
    value: !r Sys.Date()
  table_format:
    value: html
geometry: margin = 2cm
header-includes:
  - \usepackage{xcolor}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
---

---
title: "`r params$region`"
---

```{r packages, include=FALSE}
library(tidyverse)
library(tmap)
library(bcmaps)
library(tidyhydat)
library(lubridate)
library(sf)
library(rmapshaper)
library(kableExtra)
library(knitr)
library(RcppRoll)
library(shadowtext)
library(bcmapsdata)
library(ggplot2)
library(dplyr)
library(purrr)
library(ggspatial)
library(ggrepel)
library(magick)
library(ggsn)
library(tidyhydat.ws)
# Call up the function that calculates all of the drought statistics
source("C:/Users/AJOLLYMO/RProjects/hydrolook/R/droughtstats_function.R")
```
 
```{r setup, include=FALSE}

## Knitr options dependent on type of document
if(params$table_format == "latex"){
  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 8, fig.path = file.path("report/regional_streamflow/"))
}

if(params$table_format == "html"){
  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, 
                      fig.width = 8, fig.height = 8)
}

options(knitr.table.format = params$table_format)
#params <- tibble(region = "Skeena Natural Resource Region")
```




```{r load}
## For testing
#params <- tibble(date = Sys.Date(),region = "West Coast Natural Resource Region")

## Load realtime stations and convert to spatial object
stns_sf <-  st_as_sf(
    realtime_stations(prov_terr_state_loc = "BC"),
    coords = c("LONGITUDE", "LATITUDE"),
    crs = 4326,
    agr = "constant"
  ) %>%
  transform_bc_albers()

```


```{r clean}
### Spatial Cleaning

## Choose the correct region
nr_regions_sub <- filter(nr_regions(), ORG_UNIT_NAME == params$region) 

## Find the inters
region_borders <- st_intersection(nr_regions_sub, bc_bound_hres()) 

region_rivers <- st_intersection(nr_regions_sub, watercourses_5M())

wsc_drainages <- ms_simplify(wsc_drainages())

#region_watershed <- st_intersection(select(nr_regions_sub, SHAPE), wsc_drainages()) %>%
region_watershed <- st_intersection(select(nr_regions_sub, geometry), wsc_drainages()) %>%
  group_by(SUB_DRAINAGE_AREA_NAME) %>%
  summarise() %>%
  ms_simplify()

stns_region <- st_join(stns_sf, nr_regions_sub, left = FALSE) 

city <- bc_cities() %>%
  st_join(region_borders, left = FALSE) %>%
  filter(POP_2000 == max(POP_2000)) %>%
  #rename(geometry = SHAPE) %>%
  mutate(
    CENTROID = map(geometry, st_centroid),
    COORDS = map(CENTROID, st_coordinates),
    COORDS_X = map_dbl(COORDS, 1),
    COORDS_Y = map_dbl(COORDS, 2)
  ) %>%
  as_tibble() %>%
  st_sf() 

 cities <- bc_cities() %>%
  #filter(NAME %in% c("Atlin", "Fort Nelson", "Fort St. John", "Prince George",
  #                   "Smithers", "Prince Rupert", "Masset", "Kitimat", "Kelowna",
  #                   "Quesnel", "Williams Lake", "Kamloops", "Revelstoke",
  #                   "Golden", "Cranbrook", "Nelson","Vancouver",
  #                   "Victoria", "Nanaimo", "Campbell River", "Bella Coola")) %>%
   mutate(
    COORDS = map(geometry, st_coordinates),
    COORDS_X = map_dbl(COORDS, 1),
    COORDS_Y = map_dbl(COORDS, 2)
   ) ## a bit of hack to get repelled labels
  ## Some munging to individually set nudge for specific map lebels
 cities$nudge_x <- 20000
 cities$nudge_y <- 15000
 
 cities_wc <- cities %>%
   dplyr::filter(NAME %in% c("Vancouver", "Victoria", "Nanaimo", "Campbell River", "Bella Coola"))


```

```{r analysis_instant}
## All stations from the specified region, that are flow and 
## have a record longer than 20 years
stations <- stns_region$STATION_NUMBER

table_out <- drought_statistics(stations)

date_annot <- unique(table_out$Date)
 
```

This report was generated on
```{r, results='asis'}
cat(format(Sys.Date(), '%d %B, %Y'))
```

## Percentiles of Historical Flow - Last 24 Hours of Discharge

The information is taken from real time data recorded at WSC stations and is based on percentiles of long term  historical flows for that day. A percentile is a value on a scale of one hundred that indicates the percent of a distribution that is equal to or below it. In general:

- A streamflow which is greater than the 75th percentile is considered above normal
- A streamflow which is between 25th and 75th percentiles is considered normal
- A streamflow which is less than the 25 percentile is considered below normal
- A streamflow which is less than 10 percentile is considered much below normal
- The flow category "Low" indicates that the estimated streamflow is the lowest value ever measured for the day of the year

The below map shows percentile data for WSC stations, using the average of the last 24 hours of discharge data from each station:

```{r output, fig.height = 5.8, fig.width=6.4, fig.align="center"}

  ## Expected NAWW percentile bins
expected <- c("Not ranked", "Low","Much below normal (<10)", 
   "Below Normal (10-24)", "Normal (25-75)", 
   "Above normal (76-90)","Much above normal (>90)", "High")

naww_pal <- c("#9c0ad1","#F90010","#B31F23","#FEA116","#08FA09","#46DED2","#0003F6","#000000")

## Create a named vector
named_naww_pal <- setNames(naww_pal, expected)

plot_colours <- c("Not ranked" = "#9c0ad1",
                                 "Low" = "#F90010",
                      "Much below normal (<10)" = "#B31F23",
                      "Below Normal (10-24)" = "#FEA116",
                      "Normal (25-75)" = "#08FA09",
                      "Above normal (76-90)" = "#46DED2",
                      "Much above normal (>90)" = "#0003F6",
                      "High" = "#000000"
                      )

# Plot map using ggplot
ggplot() +
  geom_sf(data = region_watershed, fill = "grey95", colour = "grey90") +
  #geom_sf(data = pct_flow_last24, 
  #        aes(geometry = geometry, colour = pct_flow_last24$pct_bin),
  #        size = 3) +
    geom_sf(data = table_out, 
          aes(geometry = geometry, colour = pct_bin_last24),
          size = 3) +
  scale_colour_manual(name = "PERCENT OF NORMAL", 
                      values = plot_colours,
                      drop = FALSE) +
 geom_sf(data = cities_wc, size = 2, shape = 21, fill = "white", colour = "black") +
  geom_shadowtext(data = cities_wc,
    mapping = aes(
      x = COORDS_X,
      y = COORDS_Y,
      label = NAME
    ),
    nudge_x = cities_wc$nudge_x,
    nudge_y = cities_wc$nudge_y,
    size = 3,
    colour = "black",
    bg.colour = "white"
  ) +
  annotation_north_arrow(location = "bl", which_north = "grid", pad_x = unit(1, "cm"), pad_y = unit(9, "cm")) +
  #annotation_raster(bc_logo, 1987.509, 2283.774, 1771.908, 1790.425) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = c(.16, .20),
        legend.box.background = element_rect(),
        legend.box.margin = margin(5, 5, 5, 5))

```

\newpage
\blandscape

### Stations **much below normal** - Percentiles

The table below lists stations that are below their 10th percentile in terms of the last 24 hours of discharge data. If a location is not listed here there are no immediate low streamflow concerns. 
```{r below_normal}
much_below_normal_tbl <- as.data.frame(table_out) %>%
  dplyr::filter(pct_bin_last24 %in% c("Low","Much below normal (<10)")) %>%
  dplyr::select(`Station Name`, ID, `Record Length`, `Basin Area (km2)`, `Regulation Status`, 
                `Last 24 hour Q (m3/s)`, `Percentile - Last 24 Hour Q`, pct_bin_last24,
                `Latest 7 Day Q (m3/s)`, `Percentile - Q7`, pct_bin_7day) %>%
  dplyr::rename(`Percentile Category - Last 24 Hour Q` = pct_bin_last24, `Percentile Category - 7 Day Q` = pct_bin_7day) %>%
  dplyr::arrange(`Percentile - Last 24 Hour Q`, `Percentile - Q7`)

#date_annot <- unique(much_below_normal_tbl$Date)

if (params$table_format == "latex"){
  much_below_normal_tbl %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),
          longtable = TRUE,
          caption = paste0(params$region, " Low Flow Stations - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "hold_position", "repeat_header"), font_size = 5, full_width = T) %>%
    column_spec(6, width = "1cm", border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  much_below_normal_tbl %>%
    #dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
    #                                                                 color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
    #                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
    #                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
    #                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
    #                                                                            ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
    #                                                                                   ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
    #                                                                                          "#000000")))))))) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T,
          caption = paste0(params$region, " Low Flow Stations - ", date_annot)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}

```


## Long-Term Mean Annual Discharge (% LT MAD)

Environmental flow needs for fish  during the summer will range from juvenile rearing flows near 10-20 % (preferred) LT MAD to adult salmon/char passage flows  (>20%LT MAD) required prior to spawning.  Sub-standard flows (<10%LT MAD) can affect fish populations by reducing the area and quality of riffle habitats that generate fish food and aeration.  Flows nearing 5 % LT MAD  are considered sub-optimal for fish rearing and migration, indicate a degradation of instream habitat and may require  restrictions on water use. This data can be accessed at:  http://bcrfc.env.gov.bc.ca/freshet/map_all_wsc.html.

``` {r MADmap, fig.height = 5.8, fig.width=6.4, fig.align="center"}

MAD_below <- as.data.frame(table_out) %>%
  dplyr::select(`Station Name`, ID, `Record Length`, `Basin Area (km2)`, `Regulation Status`, `% MAD`) %>%
  dplyr::filter(`% MAD` <= 10) %>%
  dplyr::arrange(`% MAD`)


ggplot() +
  geom_sf(data = region_watershed, fill = "grey95", colour = "grey90") +
  #geom_sf(data = pct_flow_last24, 
  #        aes(geometry = geometry, colour = pct_flow_last24$pct_bin),
  #        size = 3) +
    geom_sf(data = table_out, 
          aes(geometry = geometry, colour = `% MAD`),
          size = 3) +
 # scale_colour_manual(name = "PERCENT OF NORMAL", 
#                      values = plot_colours,
#                      drop = FALSE) +
 geom_sf(data = cities_wc, size = 2, shape = 21, fill = "white", colour = "black") +
  geom_shadowtext(data = cities_wc,
    mapping = aes(
      x = COORDS_X,
      y = COORDS_Y,
      label = NAME
    ),
    nudge_x = cities_wc$nudge_x,
    nudge_y = cities_wc$nudge_y,
    size = 3,
    colour = "black",
    bg.colour = "white"
  ) +
  annotation_north_arrow(location = "bl", which_north = "grid", pad_x = unit(1, "cm"), pad_y = unit(9, "cm")) +
  #annotation_raster(bc_logo, 1987.509, 2283.774, 1771.908, 1790.425) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = c(.16, .20),
        legend.box.background = element_rect(),
        legend.box.margin = margin(5, 5, 5, 5))

```

### Table of Stations Below 10% MAD
Any stations showing values of less than 10% MAD are highlighted  in the table below. The report is showing conditions as of this morning.

```{r madtable}

if (params$table_format == "latex") {
  MAD_below %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),     
          longtable = TRUE,
          caption = paste0(params$region, " Stations at or Below 10% MAD - ", date_annot)) %>%
         # linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "repeat_header"), font_size = 5, full_width = T) 
    #column_spec(6, width = "1cm", border_left = T) %>%
    #column_spec(1, width = "3cm")
}
  
  
if (params$table_format == "html"){
  MAD_below %>%
   # dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
  #                                                                   color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
  #                                                         ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
  ##                                                                ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
  #                                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
  #                                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
  #                                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
  #                                                                                            "#000000")))))))) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T,
          caption = paste0(params$region, "Stations Below 10% MAD - ", date_annot)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}


```

## Maximum Daily Water Temperature

The recommended mean weekly maximum temperature for the protection of all fish species should not exceed 18oC; maximum daily temperature of 23oC.  
Reaching either one of these thresholds may trigger fisheries closures and water use restrictions within the  affected MUs. Table below shows stations with a maximum daily temperature above 18degC.

``` {r watertemp}

watertemp <- as.data.frame(table_out) %>%
  dplyr::select(`Station Name`, ID, `Record Length`, `Basin Area (km2)`, `Regulation Status`, `Mean Daily Water Temp (degC)`) %>%
  dplyr::filter(`Mean Daily Water Temp (degC)` >= 18) %>%
  dplyr::filter(`Mean Daily Water Temp (degC)` <= 200) %>%
  dplyr::arrange(`Mean Daily Water Temp (degC)`)

if (params$table_format == "latex") {
  watertemp %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),     
          longtable = TRUE,
          caption = paste0(params$region, "Stations Above 18degC Water Temp - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "hold_position", "repeat_header"), font_size = 5, full_width = T) %>%
    #column_spec(6, width = "1cm", border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  watertemp %>%
   # dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
  #                                                                   color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
  #                                                         ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
  ##                                                                ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
  #                                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
  #                                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
  #                                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
  #                                                                                            "#000000")))))))) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T,
          caption = paste0(params$region, "Stations Above 18degC Water Temp - ", date_annot)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}

```

## Drought Statistics Summary
The following table contains all of the drought-relevant statistics for all stations with sufficient data within the region (at least 20 years of data).

These statistics include:

  - **Last 24 hour Q**: mean discharge taken over the last 24 hours (in m3/s)
  - **Percentile - Last 24 Hour Q**: percentile of the average of the last 24 hours of discharge measurements as compared to the historical daily values
  - **Latest 7 Day Q**: Rolling 7-day average of daily mean discharge for today's date. All 7 day means are calculated based on the past 7 days.
  - **Percentile - Q7**:  Percentile of the rolling 7 day average of daily mean discharge measurements to the 7 day rolling mean of the historical daily values. 
  - **Historic Mean Q7**: Value of the rolling 7-day averaged daily mean discharge value for today's date, calculated using the station's historic data (in m3/s).
  - **Percent of Daily Mean Q7**: Percent of the Q7 for today's date compared to the mean Q7 value for today's date within the historic record of the station (i.e., Latest 7 Day Q/Historic Mean Q7 *100)
  - **Historic Median Q7**: Value of the rolling 7-day averaged daily median discharge value for today's date, calculated using the station's historic data (in m3/s).
  - **Percent of Daily Median Q7**: Percent of the Q7 for today's date compared to the median Q7 value for today's date within the historic record of the station (i.e., Latest 7 Day Q/Historic Median Q7 *100).
  - **Historic Min 7 Day Q**: The minimum 7 day averaged mean daily discharge value for today's date within the historic record (in m3/s).
  - **MEAN MAD (m^3/s) and % MAD**: Flow needs during the  summer will range from juvenile rearing flows near 10-20% (preferred) MAD to adult salmon/char passage flows (>20% MAD) required prior to spawning.  Sub-standard flows (<10% MAD) can affect fish populations by reducing the area and quality of riffle habitats that generate fish food and aeration.  Flows nearing 5% MAD are considered suboptimal for fish rearing and migration, indicate a degradation of instream habitat and may require restrictions on water use. 
  - **Mean Daily Water Temp**: Mean daily water temperature for today's date. Temperatures greater than 20 degrees C can indicate increased stress on fish populations.


```{r stats_table}



table_all <- as.data.frame(table_out) %>%
  dplyr::rename(`Percentile Category - Last 24 Hour Q` = pct_bin_last24, `Percentile Category - 7 Day Q` = pct_bin_7day) %>%
  dplyr::arrange(`Percentile - Last 24 Hour Q`, `Percentile - Q7`) %>%
  dplyr::select(-geometry)
  

if (params$table_format == "latex"){
  table_all %>%
    dplyr::select(-Date) %>% # remove date to condense table
    # Add in colours to show thresholds
   # dplyr::mutate(Percentile_Q7 = cell_spec(table_out$`Percentile - Q7`, "latex", 
  #                                          color = ifelse(table_out$`Percentile - Q7` < 10, "red", "blue"))) %>%
    kable(format = "latex", booktabs = T, digits = 1, longtable = TRUE, align = 'c', 
          caption = paste0(params$region, " Drought Statistics - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(font_size = 5, latex_options = c("HOLD_position")) %>% 
    kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T) %>%
    #kableExtra::row_spec(0, angle = 45) %>%
    column_spec(6, width = "1cm", border_left = T) %>%
   # column_spec(5, border_left = T) %>%
   # column_spec(7, border_left = T) %>%
   # column_spec(14, border_left = T) %>%
    #column_spec(16, border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  table_all %>%
    dplyr::select(-Date) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T,
          caption = paste0(params$region, " Drought Statistics - ", date_annot))  %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))  
}
  
```
\elandscape
\newpage

