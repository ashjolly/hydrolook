---
output:
  html_document:
    toc: true
    fig_caption: yes
    toc_float: true
  pdf_document:
    fig_caption: yes
  self_contained: no
params:
  region:
    value: "West Coast Natural Resource Region"
  date:
    value: !r Sys.Date()
  table_format:
    value: html
geometry: margin = 2cm
header-includes:
  - \usepackage{xcolor}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{pdflscape}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
---

---
title: "`r params$region`"
---

```{r packages, include=FALSE}
library(tidyverse)
library(tmap)
library(bcmaps)
library(tidyhydat)
library(lubridate)
library(sf)
library(sp)
library(rmapshaper)
library(kableExtra)
library(knitr)
library(RcppRoll)
library(shadowtext)
library(bcmapsdata)
library(ggplot2)
library(dplyr)
library(purrr)
library(ggspatial)
library(ggrepel)
library(magick)
library(ggsn)
library(tidyhydat.ws)
library(RColorBrewer)
library(leaflet)
# Call up the function that calculates all of the drought statistics
source("C:/Users/AJOLLYMO/RProjects/hydrolook/R/droughtstats_function.R")
```
 
```{r setup, include=FALSE}

## Knitr options dependent on type of document
if(params$table_format == "latex"){
  opts_chunk$set(echo = FALSE, 
                 warning = FALSE, 
                 message = FALSE, 
                 fig.width = 8, fig.height = 8, fig.path = file.path("report/regional_streamflow/"))
}

if(params$table_format == "html"){
  opts_chunk$set(echo = FALSE, 
                 warning = FALSE, 
                 message = FALSE, 
                 fig.width = 8, fig.height = 8)
}

options(knitr.table.format = params$table_format)
#params <- tibble(region = "Skeena Natural Resource Region")
```




```{r load, include=FALSE}
## For testing
#params <- tibble(date = Sys.Date(),region = "West Coast Natural Resource Region")

## Load realtime stations and convert to spatial object
stns_sf <-  st_as_sf(
    realtime_stations(prov_terr_state_loc = "BC"),
    coords = c("LONGITUDE", "LATITUDE"),
    crs = 4326,
    agr = "constant"
  ) %>%
  transform_bc_albers()

```


```{r clean, message = FALSE, warnings = FALSE, include = FALSE}

# Drought polugons
# -------------------------------
# LOAD BASIN SHAPEFILE AND REPROJECT
# -------------------------------
# load basin shapefile - directly from the GIS folder
drive_G = "\\\\Backhoe\\s63101\\Watershare\\rfc"
gis_path <- paste0(drive_G, "/GIS/BasinDate")
spdf <- rgdal::readOGR(gis_path, layer = 'DroughtBasin2019')
# spdf <- spTransform(spdf, CRS("+proj=longlat +datum=WGS84"))
spdf <- spTransform(spdf, CRS("+init=epsg:4326")) # transform to Google Mercator projection
# EPSG <- make_EPSG() # find CRS code
# EPSG[grepl("BC", EPSG$note), ]

# -------------------------------
# GET CENTROID OF DROUGHT BASIN POLYGONS
# -------------------------------
sp.cent <- rgeos::gCentroid(spdf, byid = TRUE, id = spdf@data$BasinName)
df.cent <- data.frame(sp.cent)
df.cent$LABEL <- row.names(df.cent)
basins <- row.names(df.cent)
#df.cent$LABEL <- basins
rownames(df.cent) <- c()

# Get only for the region
spdf_select <- spdf[spdf@data$BasinName %in% c("Central Coast", "West Vancouver Island", "East Vancouver Island", "Haida Gwaii"), ]

### Spatial Cleaning

## Choose the correct region
nr_regions_sub <- filter(nr_regions(), ORG_UNIT_NAME == params$region) 

## Find the inters
region_borders <- st_intersection(nr_regions_sub, bc_bound_hres()) 

region_rivers <- st_intersection(nr_regions_sub, watercourses_5M())

wsc_drainages <- ms_simplify(wsc_drainages())

#region_watershed <- st_intersection(select(nr_regions_sub, SHAPE), wsc_drainages()) %>%
region_watershed <- st_intersection(select(nr_regions_sub, geometry), wsc_drainages()) %>%
  group_by(SUB_DRAINAGE_AREA_NAME) %>%
  summarise() %>%
  ms_simplify()

stns_region <- st_join(stns_sf, nr_regions_sub, left = FALSE) 

city <- bc_cities() %>%
  st_join(region_borders, left = FALSE) %>%
  dplyr::filter(POP_2000 == max(POP_2000)) %>%
  #rename(geometry = SHAPE) %>%
  dplyr::mutate(
    CENTROID = map(geometry, st_centroid),
    COORDS = map(CENTROID, st_coordinates),
    COORDS_X = map_dbl(COORDS, 1),
    COORDS_Y = map_dbl(COORDS, 2)
  ) %>%
  as_tibble() %>%
  st_sf() 

 cities <- bc_cities() %>%
  #filter(NAME %in% c("Atlin", "Fort Nelson", "Fort St. John", "Prince George",
  #                   "Smithers", "Prince Rupert", "Masset", "Kitimat", "Kelowna",
  #                   "Quesnel", "Williams Lake", "Kamloops", "Revelstoke",
  #                   "Golden", "Cranbrook", "Nelson","Vancouver",
  #                   "Victoria", "Nanaimo", "Campbell River", "Bella Coola")) %>%
   mutate(
    COORDS = map(geometry, st_coordinates),
    COORDS_X = map_dbl(COORDS, 1),
    COORDS_Y = map_dbl(COORDS, 2)
   ) ## a bit of hack to get repelled labels
  ## Some munging to individually set nudge for specific map lebels
 cities$nudge_x <- 20000
 cities$nudge_y <- 15000
 
 cities_wc <- cities %>%
   dplyr::filter(NAME %in% c("Vancouver", "Victoria", "Nanaimo", "Campbell River", "Bella Coola"))


```

```{r analysisinstant}
## All stations from the specified region, that are flow and 
## have a record longer than 20 years
stations <- stns_region$STATION_NUMBER

table_out <- drought_statistics(stations) 

date_annot <- unique(table_out$Date)
 
```

This report was generated on
```{r date, results='asis'}
cat(format(Sys.Date(), '%d %B, %Y'))
```

## Percentiles of Historical Flow - 7 Day Average Streamflow

The information is taken from real time data recorded at WSC stations and is based on percentiles of long term  historical flows for that day. A percentile is a value on a scale of one hundred that indicates the percent of a distribution that is equal to or below it. In general:

- A streamflow which is greater than the 75th percentile is considered above normal
- A streamflow which is between 25th and 75th percentiles is considered normal
- A streamflow which is less than the 25 percentile is considered below normal
- A streamflow which is less than 10 percentile is considered much below normal
- The flow category "Low" indicates that the estimated streamflow is the lowest value ever measured for the day of the year

The below map shows percentile data for WSC stations using the rolling average of the last 7 days of discharge data from each station:

```{r output, fig.height = 5.8, fig.width=6.4, fig.align="center"}

## Expected NAWW percentile bins
expected <- c("Not ranked", "Low","Much below normal (<10)", 
   "Below Normal (10-24)", "Normal (25-75)", 
   "Above normal (76-90)","Much above normal (>90)", "High")

naww_pal <- c("#FFFFFF","#F90010","#B31F23","#FEA116","#08FA09","#46DED2","#0003F6","#000000")

## Create a named vector
named_naww_pal <- setNames(naww_pal, expected)

plot_colours <- c("Not ranked" = "#FFFFFF",
                      "Low" = "#F90010",
                      "Much below normal (<10)" = "#B31F23",
                      "Below Normal (10-24)" = "#FEA116",
                      "Normal (25-75)" = "#08FA09",
                      "Above normal (76-90)" = "#46DED2",
                      "Much above normal (>90)" = "#0003F6",
                      "High" = "#000000"
                      )


# Plot map using ggplot
if (params$table_format == "latex") {
  
  data_map <- table_out %>%
    st_as_sf(coords = c("LONGITUDE", "LATITUDE"),
           crs= 4326,
           agr= "constant") 

  data_map = st_as_sf(data_map, coords = c("LONGITUDE", "LATITUDE"),
                     crs = 4326, agr= "constant")
  # Plot
  ggplot() +
   geom_sf(data = region_watershed, fill = "grey95", colour = "grey90") +
  #geom_sf(data = pct_flow_last24, 
  #        aes(geometry = geometry, colour = pct_flow_last24$pct_bin),
  #        size = 3) +
    geom_sf(data = data_map, #%>% 
              #dplyr::filter(!is.na(pct_bin_7day)), 
          aes(geometry = geometry, color = pct_bin_7day), 
          size = 3) +
  scale_colour_manual(name = "PERCENT OF NORMAL", 
                      values = plot_colours,
                      drop = FALSE) +
 geom_sf(data = cities_wc, size = 2, shape = 21, fill = "white", colour = "black") +
  geom_shadowtext(data = cities_wc,
    mapping = aes(
      x = COORDS_X,
      y = COORDS_Y,
      label = NAME
    ),
    nudge_x = cities_wc$nudge_x,
    nudge_y = cities_wc$nudge_y,
    size = 3,
    colour = "black",
    bg.colour = "white"
  ) +
  annotation_north_arrow(location = "bl", which_north = "grid", pad_x = unit(1, "cm"), pad_y = unit(9, "cm")) +
  #annotation_raster(bc_logo, 1987.509, 2283.774, 1771.908, 1790.425) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = c(.16, .20),
        legend.box.background = element_rect(),
        legend.box.margin = margin(5, 5, 5, 5))
}

# Render interactive map for 
if (params$table_format == "html") {
  
  # Configure the right format for the interactive map
  interactive_data <- table_out %>%
    dplyr::filter(!is.na(pct_bin_7day)) 
  
  # Set datum
  coordinates(interactive_data) <- ~LONGITUDE+LATITUDE
  proj4string(interactive_data) <- CRS("+proj=longlat +datum=WGS84")
  # transform to Google Mercator projection
  interactive_data <- spTransform(interactive_data, CRS("+proj=longlat +datum=WGS84"))
  interactive_data <- data.frame(interactive_data)
  
 # pal <- colorFactor(palette = naww_pal, domain = expected)
  pal <- colorFactor(palette = c("#FFFFFF", "#F90010", "#B31F23", "#FEA116", "#08FA09", 
                                 "#46DED2", "#0003F6", "#000000"), levels = c("Not ranked", 
                                                                              "Low","Much below normal (<10)", 
                                                                              "Below Normal (10-24)", "Normal (25-75)", 
                                                                              "Above normal (76-90)","Much above normal (>90)", "High"))
  
  region_watershed_interactive <- st_transform(region_watershed, CRS("+init=epsg:4326")) # transform to Google Mercator projection
  
  # PLot interactive plot
  leaflet() %>%
   addProviderTiles("Esri.WorldStreetMap") %>%
   fitBounds(48, 50, -139, -120) %>%
   setView( lng = -126, lat = 54.2, zoom = 5 ) %>%
   addMapPane("polygons", zIndex = 405) %>% # order so the polygons are above the drought monitor. Lower number puts the layer closer to the bottom
   addMapPane("Drought Polygons", zIndex = 400) %>%
   addMapPane("Streamflow - Seven Day Percentiles", zIndex = 410) %>%
   addLayersControl(baseGroups = c("Drought Polygons"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
   addLayersControl(overlayGroups = c("Drought Polygons"),
                   options = layersControlOptions(collapsed = F)) %>%
   addPolygons(data = spdf_select,
              group = "Drought Polygons",
              weight = 3,
              color = '#2900b6',
              fillColor = '#white', fillOpacity = 0, # completely opaque drought polygons for now
              highlightOptions = highlightOptions(color = '#00cccc', weight = 3,
                                                  bringToFront = FALSE),
              label = ~spdf_select@data$BasinName,
              options = pathOptions(pane = "Drought Polygons"))  %>%
   addPolygons(data = region_watershed_interactive,
              group = "polygons",
              weight = 3,
              color = '#696969',
              fillColor = '#696969', fillOpacity = 0.1, 
              highlightOptions = highlightOptions(color = "black", weight = 3,
                                                  bringToFront = FALSE),
              label = "West Coast Resource Region",
              options = pathOptions(pane = "polygons")) %>%
   addCircleMarkers(data = interactive_data,
                   lng = ~LONGITUDE, lat = ~LATITUDE,
                   group = "Streamflow - Seven Day Percentiles",
                   radius = 5,
                   fillColor = ~pal(pct_bin_7day),
                   fillOpacity = 1,
                   color = "black", opacity = 0.7, weight = 1.5,
                   popup = paste0(interactive_data$`Station.Name`,", ", table_out$`ID`, "<br>",
                            "Seven Day Q (m3/s) = ", round(interactive_data$Latest.7.Day.Q..m3.s., digits = 2), "<br>", 
                            "Percentile Category: ", interactive_data$pct_bin_7day),
                   label = ~paste0(interactive_data$`Station.Name`,", ", table_out$`ID`, " ", interactive_data$pct_bin_7day),
              options = pathOptions(pane = "Streamflow - Seven Day Percentiles")) %>%
     addLegend(colors = naww_pal,
            labels = expected,
            title = paste0("7Day Streamflow Percentile Colours")) 
                   
}

```

\newpage
\blandscape

### Stations **much below normal** - Percentiles

The table below lists stations that are below their 10th percentile in terms of the last 24 hours of discharge data. If a location is not listed here there are no immediate low streamflow concerns. 
```{r belownormal}
much_below_normal_tbl <- as.data.frame(table_out) %>%
  dplyr::filter(pct_bin_24hours %in% c("Low","Much below normal (<10)")) %>%
  dplyr::select(`Station Name`, ID, `Regulation Status`, 
                `Last 24 hour Q (m3/s)`, `Percentile - Last 24 Hour Q`, pct_bin_24hours,
                `Latest 7 Day Q (m3/s)`, `Percentile - Q7`, pct_bin_7day) %>%
  dplyr::rename(`Percentile Category - Last 24 Hour Q` = pct_bin_24hours, 
                `Percentile Category - 7 Day Q` = pct_bin_7day) %>%
  dplyr::arrange(`Percentile - Last 24 Hour Q`, `Percentile - Q7`) 



#date_annot <- unique(much_below_normal_tbl$Date)

if (params$table_format == "latex"){
  much_below_normal_tbl %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),
          longtable = TRUE,
          caption = paste0(params$region, " Low Flow Stations - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "hold_position", "repeat_header"), font_size = 5, full_width = T) %>%
    column_spec(6, width = "1cm", border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  #much_below_normal_tbl %>%
    #dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
    #                                                                 color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
    #                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
    #                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
    #                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
    #                                                                            ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
    #                                                                                   ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
    #                                                                                          "#000000")))))))) %>%
    #kable(format = "html", 
    #      digits = 2, 
    #      align = rep('c'), 
    #      booktabs = T,
    #      caption = paste0(params$region, " Low Flow Stations - ", date_annot)) %>%
    #kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
  
  
  much_below_normal_tbl %>%
   kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T) %>%
          #caption = paste0(params$region, " Low Flow Stations - ", date_annot)) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
  
}

```


## Long-Term Mean Annual Discharge (% LT MAD)

Environmental flow needs for fish  during the summer will range from juvenile rearing flows near 10-20 % (preferred) LT MAD to adult salmon/char passage flows  (>20%LT MAD) required prior to spawning.  Sub-standard flows (<10%LT MAD) can affect fish populations by reducing the area and quality of riffle habitats that generate fish food and aeration.  Flows nearing 5 % LT MAD  are considered sub-optimal for fish rearing and migration, indicate a degradation of instream habitat and may require  restrictions on water use. This data can be accessed at:  http://bcrfc.env.gov.bc.ca/freshet/map_all_wsc.html.

``` {r MADmap, fig.height = 5.8, fig.width=6.4, fig.align="center"}

#plot_colours_MAD <-  c("Not ranked" = "#FFFFFF", # white for not ranked
#                      "<1%" = "#F90010",
#                      "Much below normal (<10)" = "#B31F23",
#                      "Below Normal (10-24)" = "#FEA116",
#                      "Normal (25-75)" = "#08FA09",
#                      "Above normal (76-90)" = "#46DED2",
#                      "Much above normal (>90)" = "#0003F6",
#                      "High" = "#000000"
#                      )

MAD_below <- as.data.frame(table_out) %>%
  dplyr::select(`Station Name`, ID, `Regulation Status`, `Last 24 hour Q (m3/s)`, `Latest 7 Day Q (m3/s)`, `% MAD`, `MEAN MAD (m^3/s)`) %>%
  dplyr::filter(`% MAD` <= 10) %>%
  dplyr::arrange(`% MAD`)

table_MAD <- table_out %>% 
  dplyr::arrange(as.numeric(`% MAD`)) 

table_MAD$MAD_bin <- factor(table_MAD$MAD_bin, levels = unique(table_MAD$MAD_bin), ordered=TRUE) 

# Arrange the colours for the plot

#naww_pal_MAD <- c("#FFFFFF", "#99000D", "#EF3B2C", "#FC9272",  RColorBrewer::brewer.pal(4,"Oranges"), "#4575B4")
naww_pal_MAD <- c("#FFFFFF", "#B10026",  "#FC4E2A", "#FD8D3C", 
                  "#FEB24C", "#FED976","#FFFFB2", 	
                  "#B0E0E6", # light blue
                  "#4575B4") # blue

plot_colours_MAD <- c("Not ranked" = naww_pal_MAD[1],
                      "<1%" = naww_pal_MAD[2],
                      "1 to 2%" = naww_pal_MAD[3],
                      "2 to 5%" = naww_pal_MAD[4],
                      "5 to 10%" = naww_pal_MAD[5],
                      "10 to 20%" = naww_pal_MAD[6],
                      "20 to 50%" = naww_pal_MAD[7],
                      "50 to 100%" = naww_pal_MAD[8],
                      "> 100%" = naww_pal_MAD[9]
                      )
MAD_levels <- c("Not ranked", "<1%", "1 to 2%", "2 to 5%", "5 to 10%", "10 to 20%", "20 to 50%", "50 to 100%", "> 100%")

# Plot map using ggplot
if (params$table_format == "latex") {
  
  data_map <- table_MAD %>%
    st_as_sf(coords = c("LONGITUDE", "LATITUDE"),
           crs= 4326,
           agr= "constant") 

  data_map = st_as_sf(data_map, coords = c("LONGITUDE", "LATITUDE"),
                     crs = 4326, agr= "constant")
  # Plot

ggplot() +
  geom_sf(data = region_watershed, fill = "grey95", colour = "grey90") +
  #geom_sf(data = pct_flow_last24, 
  #        aes(geometry = geometry, colour = pct_flow_last24$pct_bin),
  #        size = 3) +
    geom_sf(data = data_map, 
          aes(geometry = geometry, colour = MAD_bin), # NEED TO DO MAD BIN!!!
          size = 3) +
  scale_colour_manual(name = "% MAD", 
                      values = plot_colours_MAD,
                      drop = FALSE) +
 geom_sf(data = cities_wc, size = 2, shape = 21, fill = "white", colour = "black") +
  geom_shadowtext(data = cities_wc,
    mapping = aes(
      x = COORDS_X,
      y = COORDS_Y,
      label = NAME
    ),
    nudge_x = cities_wc$nudge_x,
    nudge_y = cities_wc$nudge_y,
    size = 3,
    colour = "black",
    bg.colour = "white"
  ) +
  annotation_north_arrow(location = "bl", which_north = "grid", pad_x = unit(1, "cm"), pad_y = unit(9, "cm")) +
  #annotation_raster(bc_logo, 1987.509, 2283.774, 1771.908, 1790.425) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = c(.16, .20),
        legend.box.background = element_rect(),
        legend.box.margin = margin(5, 5, 5, 5))
}


# Render interactive map for 
if (params$table_format == "html") {
  
  # Configure the right format for the interactive map

  interactive_data <- table_MAD 
  
  # Set datum
  coordinates(interactive_data) <- ~LONGITUDE+LATITUDE
  proj4string(interactive_data) <- CRS("+proj=longlat +datum=WGS84")
  # transform to Google Mercator projection
  interactive_data <- spTransform(interactive_data, CRS("+proj=longlat +datum=WGS84"))
  interactive_data <- data.frame(interactive_data)
  
  # Sites less that 10% MAD
  interactive_data_10 <- interactive_data %>%
                     dplyr::filter(X..MAD <= 10)
  
 # pal <- colorFactor(palette = naww_pal, domain = expected)
  pal_MAD <- colorFactor(palette = naww_pal_MAD, levels = MAD_levels)
  
  region_watershed_interactive <- st_transform(region_watershed, CRS("+init=epsg:4326")) # transform to Google Mercator projection
  
  # PLot interactive plot
  leaflet() %>%
   addProviderTiles("Esri.WorldStreetMap") %>%
   fitBounds(48, 50, -139, -120) %>%
   setView( lng = -126, lat = 54.2, zoom = 5 ) %>%
   addMapPane("polygons", zIndex = 400) %>% # Order polygons and points. Lower number puts the layer closer to the bottom
   addMapPane("Drought Polygons", zIndex = 410) %>%
   addMapPane("All sites - % MAD", zIndex = 420) %>%
   addMapPane("Sites with % MAD < 10%", zIndex = 430) %>%
   addLayersControl(baseGroups = c("All sites - % MAD",
                                   "Sites with % MAD < 10%",
                                   "Drought Polygons"),
                   options = layersControlOptions(collapsed = TRUE)) %>%
   addLayersControl(overlayGroups = c("All sites - % MAD",
                                   "Sites with % MAD < 10%",
                                   "Drought Polygons"),
                   options = layersControlOptions(collapsed = T)) %>%
   addPolygons(data = spdf_select,
              group = "Drought Polygons",
              weight = 3,
              color = '#2900b6',
              fillColor = '#white', fillOpacity = 0, # completely opaque drought polygons for now
              highlightOptions = highlightOptions(color = '#00cccc', weight = 3,
                                                  bringToFront = FALSE),
              label = ~spdf_select@data$BasinName,
              options = pathOptions(pane = "Drought Polygons")) %>%
   addPolygons(data = region_watershed_interactive,
              group = "polygons",
              weight = 3,
              color = '#696969',
              fillColor = "white", fillOpacity = 0, # completely opaque drought polygons for now
              highlightOptions = highlightOptions(color = "black", 
                                                  weight = 3,
                                                  bringToFront = FALSE),
              label = "West Coast Resource Region",
              options = pathOptions(pane = "polygons")) %>%
   addCircleMarkers(data = interactive_data,
                   lng = ~LONGITUDE, lat = ~LATITUDE,
                   group = "All sites - % MAD",
                   radius = 5,
                   fillColor = ~pal_MAD(MAD_bin),
                   fillOpacity = 1,
                   color = "black", opacity = 0.7, weight = 1.5,
                   popup = paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, "<br>",
                            "% MAD = ", round(interactive_data$X..MAD, digits = 2), "<br>", 
                            "Percentile Category: ", interactive_data$MAD_bin),
                   label = ~paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, "; % MAD = ", round(interactive_data$X..MAD, digits = 2)),
              options = pathOptions(pane = "All sites - % MAD")) %>%
  addCircleMarkers(data = interactive_data_10,
                   lng = ~LONGITUDE, lat = ~LATITUDE,
                   group = "Sites with % MAD < 10%",
                   radius = 5,
                   fillColor = ~pal_MAD(MAD_bin),
                   fillOpacity = 1,
                   color = "black", opacity = 0.7, weight = 1.5,
                   popup = paste0(interactive_data_10$`Station.Name`,", ", interactive_data_10$`ID`, "<br>",
                            "% MAD = ", round(interactive_data_10$X..MAD, digits = 2), "<br>", 
                            "Percentile Category: ", interactive_data_10$MAD_bin),
                   label = ~paste0(interactive_data_10$`Station.Name`,", ", interactive_data_10$`ID`, "; % MAD = ", round(interactive_data_10$X..MAD, digits = 2)),
              options = pathOptions(pane = "Sites with % MAD < 10%")) %>%
     addLegend(colors = naww_pal_MAD,
            labels = MAD_levels,
            title = paste0("% MAD")) 
                   
}


```

### Table of Stations Below 10% MAD
Any stations showing values of less than 10% MAD are highlighted  in the table below. The report is showing conditions as of this morning.

```{r madtable}

if (params$table_format == "latex") {
  MAD_below %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),     
          longtable = TRUE,
          caption = paste0(params$region, " Stations at or Below 10% MAD - ", date_annot)) %>%
         # linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "repeat_header"), font_size = 5, full_width = T) 
    #column_spec(6, width = "1cm", border_left = T) %>%
    #column_spec(1, width = "3cm")
}
  
  
if (params$table_format == "html"){
  MAD_below %>%
   # dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
  #                                                                   color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
  #                                                         ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
  ##                                                                ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
  #                                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
  #                                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
  #                                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
  #                                                                                            "#000000")))))))) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T) %>%
          #caption = paste0(params$region, "Stations Below 10% MAD - ", date_annot)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}


```

## Maximum Daily Water Temperature

The recommended mean weekly maximum temperature for the protection of all fish species should not exceed 18oC; maximum daily temperature of 23oC.  
Reaching either one of these thresholds may trigger fisheries closures and water use restrictions within the  affected MUs. Table below shows stations with a maximum daily temperature above 18degC.

``` {r watertempmaps}
# Maps - assemble data
table_out_temp <- table_out %>%
  dplyr::filter(!is.na(`Max temp from last 7 days (degC)`)) %>%
    dplyr::mutate(temp_bin = case_when( # Add in the % MAD categories - as per the RFC website
     is.na(`Max temp from last 7 days (degC)`) ~ "Not ranked",
     `Max temp from last 7 days (degC)` < 16 ~ "<16 degC",
     `Max temp from last 7 days (degC)` >= 16 & `Max temp from last 7 days (degC)` < 17 ~ "16 to 17",
     `Max temp from last 7 days (degC)` >= 17 & `Max temp from last 7 days (degC)` < 18 ~ "17 to 18",
     `Max temp from last 7 days (degC)` >= 18 & `Max temp from last 7 days (degC)` < 19 ~ "18 to 19",
     `Max temp from last 7 days (degC)` >= 19 & `Max temp from last 7 days (degC)` < 20 ~ "19 to 20",
     `Max temp from last 7 days (degC)` >= 20 & `Max temp from last 7 days (degC)` < 21 ~ "20 to 21",
     `Max temp from last 7 days (degC)` >= 21 & `Max temp from last 7 days (degC)` < 22 ~ "21 to 22",
     `Max temp from last 7 days (degC)` >= 22 & `Max temp from last 7 days (degC)` < 23 ~ "22 to 23",
     `Max temp from last 7 days (degC)` > 23 ~ "> or equal to 23"
   ))

# Get the watertemps
watertemp <- as.data.frame(table_out_temp) %>%
  dplyr::select(`Station Name`, ID, `Regulation Status`, `LATITUDE`, `LONGITUDE`, 
                `Max temp from last 7 days (degC)`, `Max temp over last 24 hours (degC)`,
                `Dates above 18 degC in last 7 days`, `Dates above 23 degC in last 7 days`, temp_bin) %>%
  dplyr::filter(`Max temp from last 7 days (degC)` >= 18) %>%
  dplyr::filter(`Max temp from last 7 days (degC)` <= 200) %>%
  dplyr::arrange(`Max temp from last 7 days (degC)`) %>%
  dplyr::rename(`Mean Max Daily temp (last 7 days; deg C)` = `Max temp from last 7 days (degC)`)

watertemp_all <- as.data.frame(table_out_temp) %>%
  dplyr::filter(`Max temp from last 7 days (degC)` <= 200) %>%
  dplyr::select(`Station Name`, ID, `Regulation Status`, `LATITUDE`, `LONGITUDE`,
                `Max temp from last 7 days (degC)`, `Max temp over last 24 hours (degC)`,
                `Dates above 18 degC in last 7 days`, `Dates above 23 degC in last 7 days`, temp_bin) %>%
  dplyr::arrange(`Max temp from last 7 days (degC)`) %>%
  dplyr::rename(`Mean Max Daily temp (last 7 days; deg C)` = `Max temp from last 7 days (degC)`)



# Plot map using ggplot
if (params$table_format == "latex") {
  
  data_map <- watertemp_all %>%
    st_as_sf(coords = c("LONGITUDE", "LATITUDE"),
           crs= 4326,
           agr= "constant") 

  data_map = st_as_sf(data_map, coords = c("LONGITUDE", "LATITUDE"),
                     crs = 4326, agr= "constant")
  # Plot

 ggplot() +
  geom_sf(data = region_watershed, fill = "grey95", colour = "grey90") +
  geom_sf(data = data_map, 
          aes(geometry = geometry, colour = `Mean Max Daily temp (last 7 days; deg C)`), 
          size = 3) +
  geom_sf(data = cities_wc, size = 2, shape = 21, fill = "white", colour = "black") +
  geom_shadowtext(data = cities_wc,
    mapping = aes(
      x = COORDS_X,
      y = COORDS_Y,
      label = NAME
    ),
    nudge_x = cities_wc$nudge_x,
    nudge_y = cities_wc$nudge_y,
    size = 3,
    colour = "black",
    bg.colour = "white"
  ) +
  annotation_north_arrow(location = "bl", which_north = "grid", pad_x = unit(1, "cm"), pad_y = unit(9, "cm")) +
  #annotation_raster(bc_logo, 1987.509, 2283.774, 1771.908, 1790.425) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue"),
        legend.position = c(.16, .20),
        legend.box.background = element_rect(),
        legend.box.margin = margin(5, 5, 5, 5))
}


# Render interactive map for 
if (params$table_format == "html") {
  
  # Configure the right format for the interactive map
  interactive_data <- watertemp_all 
  
  # Set datum
  coordinates(interactive_data) <- ~LONGITUDE+LATITUDE
  proj4string(interactive_data) <- CRS("+proj=longlat +datum=WGS84")
  # transform to Google Mercator projection
  interactive_data <- spTransform(interactive_data, CRS("+proj=longlat +datum=WGS84"))
  interactive_data <- data.frame(interactive_data)
  
  # Sites less that 10% MAD
  interactive_data_18 <- interactive_data %>%
          dplyr::filter(`Mean.Max.Daily.temp..last.7.days..deg.C.` >= 18) %>%
          dplyr::filter(`Mean.Max.Daily.temp..last.7.days..deg.C.` <= 200) 
  
  # get colour palette
  naww_pal_temp <- c("#FFFFFF", # Npt ranked
                     "#4575B4", # blue - less than 16
                     "#B0E0E6", # Light blue - 16 tp 17
                     "#FFFFB2", # light yellow - 17 to 18
                     "#FED976", # darker yellow - 18 to 19
                     "#FEB24C", # orange - 19 to 20
                     "#FD8D3C", # darker orange- 20 to 21
                     "#FC4E2A", # red - 21 to 22
                     "#d62703", # dark red - 22 to 23
                     "#B10026") #Dark red > 23
  temp_levels <- c("Not ranked", "<16 degC", "16 to 17", "17 to 18", "18 to 19", "19 to 20", "20 to 21", "21 to 22", "22 to 23", "> or equal to 23")
  pal_temp <- colorFactor(palette = naww_pal_temp, levels = temp_levels)
  
  region_watershed_interactive <- st_transform(region_watershed, CRS("+init=epsg:4326")) # transform to Google Mercator projection
  
  # Plot interactive plot
  leaflet() %>%
   addProviderTiles("Esri.WorldStreetMap") %>%
   fitBounds(48, 50, -139, -120) %>%
   setView( lng = -126, lat = 54.2, zoom = 5) %>%
   addMapPane("Drought Basins", zIndex = 410) %>% # order so the ploygons are above the drought monitor. Lower number puts the layer closer to the bottom
   addMapPane("Drought Polygons", zIndex = 400) %>%
   addMapPane("All sites - 7 Day Mean Max Daily Temp", zIndex = 420) %>%
   addMapPane(">18 Deg C - 7 Day Mean Max Daily Temp", zIndex = 430) %>%
   addLayersControl(baseGroups = c("All sites - 7 Day Mean Max Daily Temp",
                                   ">18 Deg C - 7 Day Mean Max Daily Temp",
                                   "Drought Polygons"),
                   options = layersControlOptions(collapsed = FALSE)) %>%
   addLayersControl(overlayGroups = c("All sites - 7 Day Mean Max Daily Temp",
                                   ">18 Deg C - 7 Day Mean Max Daily Temp",
                                   "Drought Polygons"),
                   options = layersControlOptions(collapsed = F)) %>%
   addPolygons(data = spdf_select,
              group = "Drought Polygons",
              weight = 3,
              color = '#2900b6',
              fillColor = '#white', fillOpacity = 0, # completely opaque drought polygons for now
              highlightOptions = highlightOptions(color = '#00cccc', weight = 3,
                                                  bringToFront = FALSE),
              label = ~spdf_select@data$BasinName,
              options = pathOptions(pane = "Drought Polygons")) %>% #Order the layers
   addPolygons(data = region_watershed_interactive,
              group = "Drought Basins",
              weight = 3,
              color = '#696969',
              fillColor = "white", fillOpacity = 0, # completely opaque drought polygons for now
              highlightOptions = highlightOptions(color = "black", weight = 3,
                                                  bringToFront = FALSE),
              label = "West Coast Resource Region",
              options = pathOptions(pane = "Drought Basins")) %>%
   addCircleMarkers(data = interactive_data,
                   lng = ~LONGITUDE, lat = ~LATITUDE,
                   group = "All sites - 7 Day Mean Max Daily Temp",
                   radius = 5,
                   fillColor = ~pal_temp(temp_bin),
                   fillOpacity = 1,
                   color = "black", opacity = 0.7, weight = 1.5,
                   popup = paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, "<br>",
                            "7 Day Max Daily Temp (degC) = ", round(interactive_data$Mean.Max.Daily.temp..last.7.days..deg.C., digits = 2), "<br>", 
                            "Max temp over last 24 hours (deg C) = ", interactive_data$Max.temp.over.last.24.hours..degC., "<br>", 
                            "Dates above 18degC (last 7 days) = ", interactive_data$Dates.above.18.degC.in.last.7.days, "<br>", 
                            "Dates above 23degC (last 7 days) = ", interactive_data$Dates.above.23.degC.in.last.7.days),
                   label = ~paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, 
                                   "; 7 Day Max Daily Temp (degC) = ", round(interactive_data$Mean.Max.Daily.temp..last.7.days..deg.C., digits = 2)),
                   options = pathOptions(pane = "All sites - 7 Day Mean Max Daily Temp")) %>%
  addCircleMarkers(data = interactive_data_18,
                   lng = ~LONGITUDE, lat = ~LATITUDE,
                   group = ">18 Deg C - 7 Day Mean Max Daily Temp",
                   radius = 5,
                   fillColor = ~pal_temp(temp_bin),
                   fillOpacity = 1,
                   color = "black", opacity = 0.7, weight = 1.5,
                   popup = paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, "<br>",
                            "7 Day Max Daily Temp (degC) = ", round(interactive_data$Mean.Max.Daily.temp..last.7.days..deg.C., digits = 2), "<br>", 
                            "Max temp over last 24 hours (deg C) = ", interactive_data$Max.temp.over.last.24.hours..degC., "<br>", 
                            "Dates above 18degC (last 7 days) = ", interactive_data$Dates.above.18.degC.in.last.7.days, "<br>", 
                            "Dates above 23degC (last 7 days) = ", interactive_data$Dates.above.23.degC.in.last.7.days),
                   label = ~paste0(interactive_data$`Station.Name`,", ", interactive_data$`ID`, 
                                   "; 7 Day Max Daily Temp (degC) = ", round(interactive_data$Mean.Max.Daily.temp..last.7.days..deg.C., digits = 2)),
                   options = pathOptions(pane = ">18 Deg C - 7 Day Mean Max Daily Temp"))  %>%
     addLegend(colors = naww_pal_temp,
            labels = temp_levels,
            title = paste0("7 Day Max Daily Temp")) 
                   
}




```



``` {r watertemp}
watertemp <- watertemp %>%
  dplyr::select(-LATITUDE, -LONGITUDE, -temp_bin)

if (params$table_format == "latex") {
  watertemp %>%
    kable(format = "latex", 
          booktabs = T, 
          digits = 1,
          align = rep('c'),     
          longtable = TRUE,
          caption = paste0(params$region, "Stations Above 18degC Water Temp - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(latex_options = c("HOLD_position", "striped", "hold_position", "repeat_header"), font_size = 5, full_width = T) %>%
    #column_spec(6, width = "1cm", border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  watertemp %>%
   # dplyr::mutate(`Percentile Category - Last 24 Hour Q` = cell_spec(`Percentile Category - Last 24 Hour Q`, "html", 
  #                                                                   color = ifelse(`Percentile Category - Last 24 Hour Q`  == "Low", "#F90010",
  #                                                         ifelse(`Percentile Category - Last 24 Hour Q` == "Much below normal (<10)", "#B31F23" ,
  ##                                                                ifelse(`Percentile Category - Last 24 Hour Q` == "Below Normal (10-24)" , "#FEA116", 
  #                                                                       ifelse(`Percentile Category - Last 24 Hour Q` == "Normal (25-75)" , "#08FA09", 
  #                                                                              ifelse(`Percentile Category - Last 24 Hour Q` == "Above normal (76-90)" , "#46DED2", 
  #                                                                                     ifelse(`Percentile Category - Last 24 Hour Q` == "Much above normal (>90)" , "#0003F6",
  #                                                                                            "#000000")))))))) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T) %>%
          #caption = paste0(params$region, "Stations Above 18degC Water Temp - ", date_annot)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}

```

## Drought Statistics Summary
The following table contains all of the drought-relevant statistics for all stations with sufficient data within the region (at least 20 years of data).

These statistics include:

  - **Last 24 hour Q**: mean discharge taken over the last 24 hours (in m3/s)
  - **Percentile - Last 24 Hour Q**: percentile of the average of the last 24 hours of discharge measurements as compared to the historical daily values
  - **Latest 7 Day Q**: Rolling 7-day average of daily mean discharge for today's date. All 7 day means are calculated based on the past 7 days.
  - **Percentile - Q7**:  Percentile of the rolling 7 day average of daily mean discharge measurements to the 7 day rolling mean of the historical daily values. 
  - **Historic Mean Q7**: Value of the rolling 7-day averaged daily mean discharge value for today's date, calculated using the station's historic data (in m3/s).
  - **Percent of Daily Mean Q7**: Percent of the Q7 for today's date compared to the mean Q7 value for today's date within the historic record of the station (i.e., Latest 7 Day Q/Historic Mean Q7 *100)
  - **Historic Median Q7**: Value of the rolling 7-day averaged daily median discharge value for today's date, calculated using the station's historic data (in m3/s).
  - **Percent of Daily Median Q7**: Percent of the Q7 for today's date compared to the median Q7 value for today's date within the historic record of the station (i.e., Latest 7 Day Q/Historic Median Q7 *100).
  - **Historic Min 7 Day Q**: The minimum 7 day averaged mean daily discharge value for today's date within the historic record (in m3/s).
  - **MEAN MAD (m^3/s) and % MAD**: Flow needs during the  summer will range from juvenile rearing flows near 10-20% (preferred) MAD to adult salmon/char passage flows (>20% MAD) required prior to spawning.  Sub-standard flows (<10% MAD) can affect fish populations by reducing the area and quality of riffle habitats that generate fish food and aeration.  Flows nearing 5% MAD are considered suboptimal for fish rearing and migration, indicate a degradation of instream habitat and may require restrictions on water use. 
  - **Mean Daily Water Temp**: Mean daily water temperature for today's date. Temperatures greater than 20 degrees C can indicate increased stress on fish populations.


```{r statstable}

table_all <- as.data.frame(table_out) %>%
  dplyr::select(-LATITUDE, -LONGITUDE) %>%
  dplyr::rename(`Percentile Category - Last 24 Hour Q` = pct_bin_24hours, 
                `Percentile Category - 7 Day Q` = pct_bin_7day) %>%
  dplyr::arrange(`Percentile - Last 24 Hour Q`, `Percentile - Q7`) %>%
  dplyr::rename(`Mean Max Daily temp (last 7 days; deg C)` = `Max temp from last 7 days (degC)`)
  
if (params$table_format == "latex"){
  table_all %>%
    dplyr::select(-Date) %>% # remove date to condense table
    # Add in colours to show thresholds
   # dplyr::mutate(Percentile_Q7 = cell_spec(table_out$`Percentile - Q7`, "latex", 
  #                                          color = ifelse(table_out$`Percentile - Q7` < 10, "red", "blue"))) %>%
    kable(format = "latex", booktabs = T, digits = 1, longtable = TRUE, align = 'c', 
          caption = paste0(params$region, " Drought Statistics - ", date_annot),
          linesep = "\\addlinespace") %>%
    kable_styling(font_size = 5, latex_options = c("HOLD_position")) %>% 
    kable_styling(latex_options = c("striped", "hold_position", "repeat_header"), full_width = T) %>%
    #kableExtra::row_spec(0, angle = 45) %>%
    column_spec(6, width = "1cm", border_left = T) %>%
   # column_spec(5, border_left = T) %>%
   # column_spec(7, border_left = T) %>%
   # column_spec(14, border_left = T) %>%
    #column_spec(16, border_left = T) %>%
    column_spec(1, width = "3cm")
}

if (params$table_format == "html"){
  table_all %>%
    dplyr::select(-Date) %>%
    kable(format = "html", 
          digits = 2, 
          align = rep('c'), 
          booktabs = T) %>%
          #caption = paste0(params$region, " Drought Statistics - ", date_annot))  %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
    column_spec(20, width = "3cm")
}
  
```
\elandscape
\newpage

