---
title: "Fed-Prov Hydrometric Network Diagnostic"
author: "hydrolook package"
date: "Generated on: `r Sys.Date()` "
output:
  pdf_document:
    fig_caption: yes
  html_document:
    fig_caption: yes
params:
  table_format:
    value: latex
  prov:
    value: BC
geometry: margin=2cm
---

---
subtitle: "Province examined: `r params$prov`"
---

```{r setup, include=FALSE}
#   Copyright 2017 Province of British Columbia

#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at 

#      http://www.apache.org/licenses/LICENSE-2.0

#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

## Knitr options
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
library(tidyhydat)
library(hydrolook)
library(knitr)
library(kableExtra)
library(here)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, messages = FALSE, 
                      fig.width = 8, fig.height = 8, fig.path = here("report/net_diag_lag"))

options(knitr.table.format = params$table_format) 

#params <- data.frame(table_format = "latex", prov = "NU")
```


# Scope

This document is autogenerated to output a diagnostic of hydrometric stations within the shared federal-provincial network. Real-time hydrometric data is being downloaded from Water Survey of Canada's datamart for each real-time station in the province each time this report is generated. 

# Water Office Status
The following table identifies all stations that have not currently reported in the last 6 hours:
```{r}
stns <- tidyhydat::realtime_stations(prov_terr_state_loc = params$prov)

stns_split <- split(stns$STATION_NUMBER, (seq(length(stns$STATION_NUMBER))) %/% 20)

six_hour_status <- map_dfr(stns_split, ~ check_water_office_status(.x)) 

six_hour_status %>%
  filter(DATA_LAST_SIX_HOURS == "No") %>%
  select(-PROV_TERR_STATE_LOC) %>%
  arrange(OPERATION_SCHEDULE) %>%
  kable(format = "latex", booktabs = T) %>%
  kable_styling(font_size = 6,latex_options = c("striped", "HOLD_position"))
```

# Datamart Status
The following stations are listed on the [hydrometric station list](http://dd.weather.gc.ca/hydrometric/doc/hydrometric_StationList.csv) both not in the  [datamart](http://dd.weather.gc.ca/hydrometric/csv/). These stations can be considered stations that are not transmitting real-time data but should be. If no table is presented, all stations are reporting in realtime. 
```{r, message=TRUE}
check_datamart_status(params$prov)
```

# Stations that haven't reported in the past 6 hours
## Continuous stations
```{r, message = FALSE, fig.height = 5, fig.width = 10}
continuous <- six_hour_status %>%
  filter(DATA_LAST_SIX_HOURS == "No", OPERATION_SCHEDULE == "Continuous")

if(nrow(continuous) > 0){
  continuous %>%
    pull(STATION_NUMBER) %>%
    realtime_dd() %>%
    left_join(stns,by = c("STATION_NUMBER", "PROV_TERR_STATE_LOC")) %>%
    filter(!is.na(STATION_NUMBER), !is.na(Value)) %>%
    mutate(STATION = paste0(STATION_NAME, " - ", STATION_NUMBER)) %>%
    ggplot(aes(x = Date, y = STATION, colour = Value)) +
    geom_point() +
    facet_wrap(~Parameter, ncol = 2) +
    scale_colour_viridis_c() +
    theme_minimal()
}
```

## Seasonal stations
```{r, message = FALSE, fig.height = 5, fig.width = 10}
seasonal <- six_hour_status %>%
  filter(DATA_LAST_SIX_HOURS == "No", OPERATION_SCHEDULE == "Seasonal") 

if(nrow(seasonal) > 0){
  seasonal %>%
    pull(STATION_NUMBER) %>%
    realtime_dd() %>%
    left_join(stns,by = c("STATION_NUMBER", "PROV_TERR_STATE_LOC")) %>%
    filter(!is.na(STATION_NUMBER), !is.na(Value)) %>%
    mutate(STATION = paste0(STATION_NAME, " - ", STATION_NUMBER)) %>%
    ggplot(aes(x = Date, y = STATION, colour = Value)) +
    geom_point() +
    facet_wrap(~Parameter, ncol = 2) +
    scale_colour_viridis_c() +
    theme_minimal()
}
```

