---
title: "BC Fed-Prov Hydrometric Network Diagnostic"
author: "Sam Albers"
date: "Generated on: `r Sys.Date()` "
output:
  html_document:
    toc: true
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, messages = FALSE, fig.width = 8, fig.height = 12)

library(dplyr)
library(tidyr)
library(tidyhydat)
library(hydrolook)
library(sf)
library(ggplot2)
library(knitr)
library(kableExtra)

options(knitr.table.format = "html") 

#station_number <- "10BE001"
#station_number <- c("08ND012", "08NH138", "08JA023", "08FA007", "07FD010", "08NH007", 
#"08LB038", "08HB087", "08NH127", "08MH141", "08KH010", "08CD001", 
#"08NE074", "08LB076", "09AA001", "08HA001", "08MH126", "08NM116", 
#"08NK016", "07FB009", "08KD007", "08MA003", "08PA004", "08HB075", 
#"08NB014", "08HB032", "07EE010", "08LC003", "08EE012", "08KE018"
#)


## Change to sf
bc_bound_sf <- st_as_sf(bcmaps::bc_bound_hres)
hydrozones_sf <- st_as_sf(bcmaps::hydrozones) %>%
  select(HYDZN_NAME)
  

```


# Introduction

This document is autogenerated to output a diagnostic of hydrometric stations within the shared federal-provincial network. Real-time hydrometric data is being downloaded from Water Survey of Canada's datamart for each real-time station in the province each time this report is generated. Data is subsequently passed through several criteria to determine if potential data problems are occuring. Stations flagged are listed according to the criteria that generated that flag. 

## Criteria
The criteria are generalized in the section. Criteria specification is reflected in this section. All subsequent data presentation and visualization can be directed back to this section for context.

- Is the station listed on both [hydrometric station list](http://dd.weather.gc.ca/hydrometric/doc/hydrometric_StationList.csv) and in the [datamart](http://dd.weather.gc.ca/hydrometric/csv/)?

- Does this station have any data gaps larger than `gap_threshold`?

```{r thres, eval=TRUE}
gap_threshold <- 3600
cat(paste0("gap_threshold = ", gap_threshold, " minutes"))
```
- Does this station has more than `number_gaps` gaps that are longer than 20 minutes?

```{r}
number_gaps <- 10
cat(paste0("number_gaps = ", number_gaps, " (number of gaps that are 20 minutes or longer)"))
```

```{r run_analysis, error=TRUE, warning=FALSE, message=FALSE}
gaps <- check_stn_gap(STATION_NUMBER = NULL, PROV_TERR_STATE_LOC = "BC", gap_thres = gap_threshold, num_gaps = number_gaps) %>%
  do(st_as_sf(., coords = c("LONGITUDE", "LATITUDE"), 
              crs = 4326, 
              agr = "constant")) %>%
  st_transform(crs = 3005) %>%
  st_join(., hydrozones_sf)
```

#  Stations that pass all test
The following is a percent of stations that pass all tests are criteria. These stations are likely performing optimally and are not considered in the analysis below: 
```{r}
number_of_stations = nrow(gaps)

number_of_stations_np = nrow(filter(gaps, Status == "in datamart" & Criteria1 == FALSE & Criteria2 == FALSE))

cat(paste0("Percent of all stations that pass all tests and criteria: ", 
           round((number_of_stations_np/number_of_stations)*100, 3), "%"))


```

# Datamart Issues
The following stations are listed on the [hydrometric station list](http://dd.weather.gc.ca/hydrometric/doc/hydrometric_StationList.csv) both not in the  [datamart](http://dd.weather.gc.ca/hydrometric/csv/). These stations can be considered stations that are not transmitting real-time data but should be. 
```{r}
no_datamart = gaps %>%
  st_set_geometry(., NULL) %>%
  select(STATION_NUMBER, STATION_NAME, Status, HYDZN_NAME) %>%
  filter(!Status == "in datamart")

kable(no_datamart) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

# Long Data Gaps
Tables, maps and figures are only printed if any stations meet the long data gap criteria. That is repeated here from convenience:

- Does this station have any data gaps larger than `gap_threshold`?

```{r}
cat(paste0("gap_threshold = ", gap_threshold, " minutes"))
```

## Table
```{r ldg}
  ldg <- gaps %>%
    st_set_geometry(., NULL) %>%
    filter(Criteria1 == TRUE)

if (nrow(ldg) != 0){
  knitr::kable(ldg) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
} else{
  cat("No stations have data gaps longer than ", gap_threshold, "minutes")
}
```

## Map 
```{r map_ldg, fig.width = 8, fig.height = 8}
if (nrow(ldg) != 0){
  ggplot(hydrozones_sf) +
    geom_sf() +
    geom_sf(data = bc_bound_sf, alpha = 0.5) +
    geom_sf(data = filter(gaps, Criteria1 == TRUE), 
            aes(colour = STATION_NUMBER, fill = STATION_NUMBER)) +
    coord_fixed() +
    coord_sf(crs = st_crs(3005)) +
    theme_minimal() +
    theme(legend.position = "bottom") +
    labs(x = "Longitude", y = "Latitude", caption = "Sub-divisions represent BC hydrologic zones")
}
```

## Figure
```{r realdata_ldg}
#Output a figure if no anything meets Criteria 1
if (nrow(ldg) != 0){
  all_real <- download_realtime_dd(STATION_NUMBER = ldg$STATION_NUMBER, PROV_TERR_STATE_LOC = "BC")
  #all_real <- bind_realtime(stations = ldg$station_number) 
} #else {
  #all_real <- download_realtime2(STATION_NUMBER = station_number, PROV_TERR_STATE_LOC = "BC")
#}
```

### Stage Height
```{r hplot_ldg}
if (nrow(ldg) != 0){
# generate the groups automatically and plot
all_real %>%
  filter(Parameter == "LEVEL") %>%
  ggplot(aes(x = Date, y = Value)) +
  geom_line() +
  geom_point(size = 1) +
  facet_wrap(~STATION_NUMBER, scales = "free_y") +
  theme_minimal() +
  labs(x = "Date", y = "Stage Height (m)") +
  scale_x_datetime(date_breaks = "2 week", date_labels = "%b %d")
}
```

### Discharge
```{r qplot_ldg}
if (nrow(ldg) != 0){
# generate the groups automatically and plot
all_real %>%
  filter(Parameter == "FLOW") %>%
  ggplot(aes(x = Date, y = Value)) +
  geom_line() +
  geom_point(size = 1) +
  facet_wrap(~STATION_NUMBER, scales = "free_y") +
  theme_minimal() +
  labs(x = "Date", y = "Discharge (m^3/s)") +
  scale_x_datetime(date_breaks = "2 week", date_labels = "%b %d")
}
```


# Frequent Data Gaps
Tables, maps and figures are only printed if any stations meet the long data gap criteria. This criteria is repeated here for convenience:

```{r}
cat(paste0("number_gaps = ", number_gaps, " (number of gaps that are 20 minutes or longer)"))
```

## Table
```{r fdg}
fdg <- gaps %>%
  st_set_geometry(., NULL) %>%
  filter(Criteria2 == TRUE)

if (nrow(fdg) != 0){
  kable(fdg) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
} else{
  cat("No stations have data gaps longer than ", number_gaps, "minutes")
}
```

## Map 
```{r map_fdg, fig.width = 8, fig.height = 8}
if (nrow(fdg) != 0){
  ggplot(hydrozones_sf) +
    geom_sf() +
    geom_sf(data = bc_bound_sf, alpha = 0.5) +
    geom_sf(data = filter(gaps, Criteria2 == TRUE), 
            aes(colour = STATION_NUMBER, fill = STATION_NUMBER)) +
    coord_fixed() +
    coord_sf(crs = st_crs(3005)) +
    theme_minimal() +
    theme(legend.position = "bottom") +
    labs(x = "Longitude", y = "Latitude", caption = "Sub-divisions represent BC hydrologic zones") 
}
```

## Figure
```{r realdata_fdg}
if (nrow(fdg) != 0){
  all_real <- download_realtime_dd(STATION_NUMBER = fdg$STATION_NUMBER)
} #else {
  #all_real <- download_realtime2(STATION_NUMBER = station_number, PROV_TERR_STATE_LOC = "BC")
#}
```

### Stage Height
```{r hplot_fdg}
if (nrow(fdg) != 0){
  # generate the groups automatically and plot
  all_real %>%
    filter(Parameter == "LEVEL") %>%
    ggplot(aes(x = Date, y = Value)) +
    geom_line() +
    geom_point(size = 1) +
    facet_wrap(~STATION_NUMBER, scales = "free_y") +
    theme_minimal() +
    labs(x = "Date", y = "Stage Height (m)") +
    scale_x_datetime(date_breaks = "2 week", date_labels = "%b %d")
}
```

### Discharge
```{r qplot_fdg}
if (nrow(fdg) != 0){
  # generate the groups automatically and plot
  all_real %>%
    filter(Parameter == "FLOW") %>%
    ggplot(aes(x = Date, y = Value)) +
    geom_line() +
    geom_point(size = 1) +
    facet_wrap(~STATION_NUMBER, scales = "free_y") +
    theme_minimal() +
    labs(x = "Date", y = "Discharge (m^3/s)") +
    scale_x_datetime(date_breaks = "2 week", date_labels = "%b %d")
}
```


# License

    Copyright 2017 Province of British Columbia

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at 

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
